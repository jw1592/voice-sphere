<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Voice Sphere</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #000;
            touch-action: none; /* 모바일에서 기본 터치 동작 비활성화 */
            -webkit-touch-callout: none; /* iOS에서 길게 터치할 때 메뉴 비활성화 */
            -webkit-user-select: none; /* 텍스트 선택 비활성화 */
            user-select: none;
        }
        canvas {
            display: block;
        }
        #audio-player {
            display: none;
        }
    </style>
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.175.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.175.0/examples/jsm/"
        }
    }
    </script>
</head>
<body>
    <audio id="audio-player" loop>
        <source src="assets/audio/background.mp3" type="audio/mp3">
        브라우저가 오디오를 지원하지 않습니다.
    </audio>

    <script type="module">
        import * as THREE from 'three';
        import { TrackballControls } from 'three/addons/controls/TrackballControls.js';

        // Three.js 설정
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // TrackballControls 추가
        const controls = new TrackballControls(camera, renderer.domElement);
        controls.rotateSpeed = 3.0;
        controls.zoomSpeed = 1.2;
        controls.panSpeed = 0.8;
        controls.noZoom = false;
        controls.noPan = true;
        controls.staticMoving = false;
        controls.dynamicDampingFactor = 0.05;
        controls.minDistance = 3;
        controls.maxDistance = 10;
        controls.target = new THREE.Vector3(0, 0, 0);

        // 모바일 터치 이벤트 방지
        document.addEventListener('touchmove', function(e) {
            e.preventDefault();
        }, { passive: false });

        // 더블탭 줌 방지
        document.addEventListener('dblclick', function(e) {
            e.preventDefault();
        }, { passive: false });

        // 점들로 구성된 스피어 생성
        const particlesGeometry = new THREE.BufferGeometry();
        const particlesCount = 3000;
        const positions = new Float32Array(particlesCount * 3);
        const radius = 2;

        for(let i = 0; i < particlesCount; i++) {
            const theta = Math.random() * Math.PI * 2;
            const phi = Math.acos((Math.random() * 2) - 1);
            
            const x = radius * Math.sin(phi) * Math.cos(theta);
            const y = radius * Math.sin(phi) * Math.sin(theta);
            const z = radius * Math.cos(phi);

            positions[i * 3] = x;
            positions[i * 3 + 1] = y;
            positions[i * 3 + 2] = z;
        }

        particlesGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));

        const particlesMaterial = new THREE.PointsMaterial({
            size: 0.02,
            color: 0x00ff00,
            transparent: true,
            opacity: 0.8,
            sizeAttenuation: true
        });

        const particlesMesh = new THREE.Points(particlesGeometry, particlesMaterial);
        scene.add(particlesMesh);

        // 카메라 위치 초기화 함수
        function resetCameraPosition() {
            camera.position.set(0, 0, 5);
            camera.lookAt(0, 0, 0);
            controls.target.set(0, 0, 0);
            controls.update();
        }

        // 창 크기 조절 시 카메라 위치 재설정
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            controls.handleResize();
            resetCameraPosition(); // 카메라 위치 초기화
        }

        // 초기 카메라 위치 설정
        resetCameraPosition();

        // 랜덤 회전 속도 설정
        const rotationSpeed = {
            x: (Math.random() - 0.5) * 0.001,
            y: (Math.random() - 0.5) * 0.001,
            z: (Math.random() - 0.5) * 0.001
        };

        // 마우스 휠 이벤트
        let particleSize = 0.02;
        window.addEventListener('wheel', (event) => {
            particleSize = Math.max(0.01, Math.min(0.05, particleSize + event.deltaY * -0.0001));
            particlesMaterial.size = particleSize;
        });

        // 애니메이션
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            
            // 자동 회전
            particlesMesh.rotation.x += rotationSpeed.x;
            particlesMesh.rotation.y += rotationSpeed.y;
            particlesMesh.rotation.z += rotationSpeed.z;
            
            renderer.render(scene, camera);
        }

        animate();

        // 오디오 재생 함수
        const audioPlayer = document.getElementById('audio-player');
        let hasInteracted = false;

        function startAudio() {
            if (!hasInteracted) {
                hasInteracted = true;
                audioPlayer.play().catch(error => {
                    console.log("오디오 재생 실패:", error);
                });
            }
        }

        // 모바일 여부 확인
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

        if (isMobile) {
            // 모바일: 첫 터치에 음악 재생
            document.addEventListener('touchstart', startAudio, { once: true });
        } else {
            // 데스크톱: 마우스 진입 시 음악 재생
            document.addEventListener('mouseover', startAudio, { once: true });
        }

        // 페이지 visibility 변경 시 오디오 처리
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                audioPlayer.pause();
            } else if (hasInteracted) {
                audioPlayer.play().catch(error => {
                    console.log("오디오 재생 실패:", error);
                });
            }
        });
    </script>
</body>
</html> 